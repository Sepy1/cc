<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buat Tiket — Nasabah</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#fff;
      --muted:#6b7280;
      --accent:#4f46e5;
      --radius:12px;
      --border:#e6e8eb;
      --input-bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; margin:0; min-height:100vh; background:linear-gradient(180deg,#fff,#fbfbfd); display:flex; align-items:flex-start; justify-content:center; padding:28px; color:#0b1220}

    .wrap{width:100%; max-width:1120px}
    .card{background:var(--card); border-radius:14px; padding:34px; box-shadow:0 12px 30px rgba(2,6,23,0.06); border:1px solid rgba(11,17,32,0.04); position:relative}

    h1{margin:0 0 6px; font-size:22px; font-weight:700}
    p.lead{margin:0 0 20px; color:var(--muted); font-size:14px}

    form{display:block}

    /* layout grids */
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:28px; margin-bottom:18px}
    .grid-2{display:grid; grid-template-columns:repeat(2,1fr); gap:28px; margin-bottom:18px}
    .full{margin-bottom:18px}

    label.block{display:block}
    .label-title{font-weight:600; margin-bottom:6px; display:block; font-size:16px}
    .label-note{color:var(--muted); font-size:13px; margin-bottom:8px; display:block}

    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], textarea, select, input[type="file"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--input-bg); font-size:14px; outline:none; color:#0b1220; box-shadow:none; height:44px;
    }
    textarea{min-height:120px; resize:vertical; padding-top:14px}
    input[disabled]{opacity:0.6}

    input::placeholder, textarea::placeholder{color:#6b7280}

    input:focus, textarea:focus, select:focus{border-color:var(--accent); box-shadow:0 8px 28px rgba(79,70,229,0.06)}

    .actions{display:flex; gap:12px; align-items:center; justify-content:flex-start; margin-top:6px}
    .btn{padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700}
    .btn.primary{background:var(--accent); color:white}
    .btn.ghost{background:transparent; border:1px solid var(--border); color:var(--muted)}

    .msg{margin-top:10px; font-size:14px}
    .ok{color:#0ea5a4}
    .err{color:#b91c1c; white-space:pre-wrap}

    .required{color:#b91c1c; margin-left:6px; font-weight:700}

    /* responsive */
    @media (max-width:1200px){
      .card{padding:22px}
    }
    @media (max-width:980px){
      .grid-3{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:720px){
      .grid-3,.grid-2{grid-template-columns:1fr}
      .card{padding:18px}
    }

    .file-row{display:grid; grid-template-columns:1fr 1fr; gap:36px; margin-top:6px}
    .submit-row{display:flex; gap:18px; align-items:center; margin-top:18px}

    /* ticket search box */
    .search-row{display:flex; gap:12px; margin-bottom:18px; align-items:center}
    .search-input{flex:1}
    .ticket-card{border:1px solid var(--border); border-radius:10px; padding:14px; background:linear-gradient(180deg,#fff,#fbfbfd); margin-top:12px}
    .ticket-row{display:flex; gap:12px; flex-wrap:wrap}
    .ticket-col{min-width:160px}
    .small-note{font-size:13px; color:var(--muted)}
    .attachment-list{margin-top:8px}
    .attachment-list a{display:inline-block; margin-right:8px; font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Buat Tiket — Nasabah</h1>

      <!-- SEARCH TICKET -->
      <div>
        <div class="label-note">Cari tiket berdasarkan nomor tiket. Endpoint: <code>GET /tickets/{ticket_no}</code></div>
        <div class="search-row" style="margin-top:8px;">
          <input type="text" id="searchTicketNo" class="search-input" placeholder="Masukkan nomor tiket (mis. TKT-20251207-001)" />
          <button id="btnSearch" class="btn ghost">Cari Tiket</button>
        </div>
        <div id="searchMsg" class="msg" role="status" aria-live="polite"></div>
        <div id="searchResult"></div>
        <hr style="margin:18px 0;">
      </div>

      <!-- CREATE TICKET FORM -->
      <form id="ticketForm" autocomplete="off" enctype="multipart/form-data" novalidate>
        <input type="hidden" name="reporter_type" value="nasabah">

        <div class="grid-2">
          <label class="block">
            <span class="label-title">Nama Nasabah <span class="required">*</span></span>
                <input type="text" name="reporter_name" placeholder="Nama lengkap" required>
          </label>

          <label class="block">
            <span class="label-title">Email <span class="required">*</span></span>
            <input type="email" name="email" placeholder="email@contoh.com" required>
          </label>
        </div>

        <div class="grid-3">
          <label class="block">
            <span class="label-title">No e-KTP</span>
            <input type="text" name="id_ktp" placeholder="Nomor KTP / e-KTP">
          </label>

          <label class="block">
            <span class="label-title">Nama Ibu</span>
            <input type="text" name="nama_ibu" placeholder="Nama ibu kandung">
          </label>

          <label class="block">
            <span class="label-title">Alamat <span class="required">*</span></span>
            <input type="text" name="alamat" placeholder="Alamat domisili" required>
          </label>
        </div>

        <div class="grid-3">
          <label class="block">
            <span class="label-title">Tempat Lahir <span class="required">*</span></span>
            <input type="text" name="tempat_lahir" placeholder="Kota tempat lahir" required>
          </label>

          <label class="block">
            <span class="label-title">Tanggal Lahir <span class="required">*</span></span>
            <input type="date" name="tgl_lahir" required>
          </label>

          <label class="block">
            <span class="label-title">No. Telepon / HP <span class="required">*</span></span>
            <input type="tel" name="phone" placeholder="08xx xxxx xxxx" required>
          </label>

          <label class="block">
            <span class="label-title">No. Rekening <span class="required">*</span></span>
            <input type="text" name="nomor_rekening" placeholder="Nomor rekening" required>
          </label>

          <label class="block">
            <span class="label-title">Kantor Cabang <span class="required">*</span></span>
            <select name="kode_kantor" required>
              <option value="" disabled selected>-- Pilih Kantor Cabang --</option>
              <option value="001">Kantor Cabang Utama</option>
              <option value="002">Rembang</option>
              <option value="003">Pati</option>
              <option value="004">Demak</option>
              <option value="005">Kendal</option>
              <option value="006">Salatiga</option>
              <option value="007">Semarang</option>
              <option value="008">Wonogiri</option>
              <option value="009">Surakarta</option>
              <option value="010">Karanganyar</option>
              <option value="011">Sukoharjo</option>
              <option value="012">Sragen</option>
              <option value="013">Boyolali</option>
              <option value="014">Magelang</option>
              <option value="015">Wonosobo</option>
              <option value="016">Purworejo</option>
              <option value="017">Kebumen</option>
              <option value="018">Banjarnegara</option>
              <option value="019">Purbalingga</option>
              <option value="020">Banyumas</option>
              <option value="021">Cilacap</option>
              <option value="022">Kabupaten Tegal</option>
              <option value="023">Brebes</option>
              <option value="024">Kota Tegal</option>
              <option value="025">Pemalang</option>
              <option value="026">Kota Pekalongan</option>
              <option value="027">Kabupaten Pekalongan</option>
              <option value="028">Batang</option>
            </select>
          </label>

          <label class="block">
            <span class="label-title">Pokok Pengaduan (Kategori) <span class="required">*</span></span>
            <select name="category" required>
              <option value="" disabled selected>-- Pilih kategori --</option>
              <option value="tabungan">Tabungan</option>
              <option value="kredit">Kredit</option>
              <option value="deposito">Deposito</option>
              <option value="layanan_digital">Layanan Digital</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </label>

        </div>

        <div class="grid-3">
          <label class="block">
            <span class="label-title">Tanggal Kejadian</span>
            <input type="date" name="tanggal_kejadian">
          </label>

          <label class="block">
            <span class="label-title">Judul Tiket <span class="required">*</span></span>
            <input type="text" name="title" placeholder="Contoh: Transfer belum masuk" required>
          </label>
        </div>

        <div class="full">
          <label class="block">
            <span class="label-title">Deskripsi Permasalahan <span class="required">*</span></span>
            <small class="label-note">Kronologis kejadian, tanggal & waktu, nominal transaksi, dll</small>
            <textarea name="detail" placeholder="Tuliskan kronologi singkat dan jelas..." required></textarea>
          </label>
        </div>

        <div class="file-row">
          <label class="block">
            <span class="label-title">Upload Foto / Scan KTP <span class="required">*</span></span>
            <small class="label-note">(jpg, png, pdf) — field <code>attachment_ktp</code></small>
            <input type="file" name="attachment_ktp" accept="image/*,.pdf" required>
          </label>

          <label class="block">
            <span class="label-title">Upload Bukti / Screenshot Transaksi</span>
            <small class="label-note">(opsional) — field <code>attachment_bukti</code></small>
            <input type="file" name="attachment_bukti" accept="image/*,.pdf">
          </label>
        </div>

        <input type="hidden" name="status" value="open">

        <div class="submit-row">
          <button type="button" class="btn ghost" id="btnReset">Reset Form</button>
          <button type="submit" class="btn primary" id="btnSubmit">Submit</button>
        </div>

        <div id="msg" class="msg" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const LS_KEY = 'tiket_api_url';
      const DEFAULT_API = 'https://localhost:8000/api/tickets';

      function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      ready(main);

      function normalizeApiUrl(input){
        // ensure full endpoint ends with /api/tickets (no trailing slash)
        if (!input) return DEFAULT_API;
        let u = input.trim();
        if (u.endsWith('/')) u = u.slice(0, -1);
        if (u.match(/\/api(\/|$)/)) {
          if (u.match(/\/api\/tickets(\/|$)/)) {
            return u.replace(/\/$/,'');
          }
          return u + '/tickets';
        }
        return u + '/api/tickets';
      }

      function getTicketsBase(input){
        // returns base /api/tickets without trailing slash
        return normalizeApiUrl(input);
      }

      function getTicketUrl(ticketNo){
        const base = getTicketsBase(getSavedApi());
        // append ticketNo, ensure no double slashes
        return base + '/' + encodeURIComponent(ticketNo);
      }

      function getSavedApi(){
        return localStorage.getItem(LS_KEY) || DEFAULT_API;
      }

      function setMsg(elId, text, type=''){
        const msg = document.getElementById(elId);
        if (!msg) return;
        msg.textContent = text;
        msg.className = 'msg ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : '');
      }
      function clearMsg(elId){
        const msg = document.getElementById(elId);
        if (!msg) return;
        msg.textContent = '';
        msg.className = 'msg';
      }

      async function postJson(url, obj){
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(obj),
          mode: 'cors'
        });
        return res;
      }

      async function postFormData(url, fd){
        const res = await fetch(url, {
          method: 'POST',
          // DO NOT set Content-Type here; browser will set multipart/form-data boundary
          headers: { 'Accept': 'application/json' },
          body: fd,
          mode: 'cors'
        });
        return res;
      }

      async function getJson(url){
        const res = await fetch(url, {
          method: 'GET',
          headers: { 'Accept': 'application/json' },
          mode: 'cors'
        });
        return res;
      }

      function parseJsonSafe(res){
        return res.text().then(txt => {
          try { return txt ? JSON.parse(txt) : {}; }
          catch(e){ return { _raw: txt }; }
        });
      }

      function ensureUrl(u) {
        if (!u) return null;
        // If already absolute, return
        if (/^https?:\/\//i.test(u)) return u;
        // If it's a storage-relative path like tickets/ktp/..., prefix /storage/
        if (!u.startsWith('/')) return '/storage/' + u.replace(/^\/+/, '');
        return u;
      }

      function renderTicket(data){
        const container = document.getElementById('searchResult');
        container.innerHTML = '';
        if (!data) return;

        const t = data?.data || data || {};
        const el = document.createElement('div');
        el.className = 'ticket-card';

        // header
        const h = document.createElement('div');
        h.innerHTML = '<strong>Nomor Tiket:</strong> ' + (t.ticket_no || '-') + ' &nbsp; <span class="small-note">[' + (t.status || '-') + ']</span>';
        el.appendChild(h);

        // basic rows
        const row = document.createElement('div');
        row.className = 'ticket-row';
        const addCol = (title, val) => {
          const c = document.createElement('div');
          c.className = 'ticket-col';
          c.innerHTML = '<div class="small-note">'+ title +'</div><div>' + (val || '-') + '</div>';
          row.appendChild(c);
        };
        addCol('Pelapor', t.reporter_name || '-');
        addCol('Email / Telp', (t.email || '-') + (t.phone ? ' / ' + t.phone : ''));
        addCol('Kategori', t.category || '-');
        addCol('Cabang', t.kode_kantor || '-');
        addCol('Tanggal dibuat', t.created_at || '-');
        el.appendChild(row);

        // title & detail
        const title = document.createElement('div');
        title.style.marginTop = '12px';
        title.innerHTML = '<strong>' + (t.title || '-') + '</strong>';
        el.appendChild(title);

        const detail = document.createElement('div');
        detail.style.marginTop = '8px';
        detail.innerHTML = '<div class="small-note">Detail Permasalahan</div><pre style="white-space:pre-wrap;margin:0;font-family:inherit;">' + (t.detail ?? '-') + '</pre>';
        el.appendChild(detail);

        // added: tindak lanjut
        const tindak = document.createElement('div');
        tindak.style.marginTop = '8px';
        tindak.innerHTML = '<div class="small-note">Tindak Lanjut</div><pre style="white-space:pre-wrap;margin:0;font-family:inherit;">' + (t.tindak_lanjut ?? '-') + '</pre>';
        el.appendChild(tindak);

        // Attachments: prefer normalized URLs
        const ktpUrl = ensureUrl(t.attachment_ktp_url || t.attachment_ktp);
        const buktiUrl = ensureUrl(t.attachment_bukti_url || t.attachment_bukti);

        if (ktpUrl || buktiUrl) {
          const attWrap = document.createElement('div');
          attWrap.className = 'attachment-list';
          attWrap.innerHTML = '<div class="small-note">Lampiran:</div>';
          if (ktpUrl) {
            const a1 = document.createElement('a');
            a1.href = ktpUrl;
            a1.target = '_blank';
            a1.rel = 'noopener noreferrer';
            a1.textContent = 'KTP';
            attWrap.appendChild(a1);
          }
          if (buktiUrl) {
            const a2 = document.createElement('a');
            a2.href = buktiUrl;
            a2.target = '_blank';
            a2.rel = 'noopener noreferrer';
            a2.textContent = 'Bukti';
            attWrap.appendChild(a2);
          }
          el.appendChild(attWrap);
        }

        container.appendChild(el);
      }

      async function handleSearchTicket(ticketNo){
        clearMsg('searchMsg');
        const resultEl = document.getElementById('searchResult');
        resultEl.innerHTML = '';
        if (!ticketNo || !ticketNo.trim()) {
          setMsg('searchMsg','Masukkan nomor tiket yang valid','err');
          return;
        }
        const btn = document.getElementById('btnSearch');
        if (btn) { btn.disabled = true; btn.textContent = 'Mencari...'; }

        try {
          const url = getTicketUrl(ticketNo.trim());
          const res = await getJson(url);
          const data = await parseJsonSafe(res);
          if (!res.ok || data?.success === false) {
            const msg = (data?.message) ? data.message :
                        (data?._raw) ? data._raw :
                        `HTTP ${res.status} ${res.statusText}`;
            setMsg('searchMsg','Gagal mengambil tiket: ' + msg, 'err');
          } else {
            setMsg('searchMsg','Tiket ditemukan','ok');
            renderTicket(data);
          }
        } catch (err) {
          setMsg('searchMsg','Terjadi kesalahan: ' + (err.message || err), 'err');
          console.error(err);
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = 'Cari Tiket'; }
        }
      }

      function main(){
        const form = document.getElementById('ticketForm');
        const btnReset = document.getElementById('btnReset');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnSearch = document.getElementById('btnSearch');
        const inputSearch = document.getElementById('searchTicketNo');

        if (!form) return console.warn('Form not found');

        btnReset && btnReset.addEventListener('click', () => { form.reset(); clearMsg('msg'); });

        form.addEventListener('submit', async function(e){
          e.preventDefault(); clearMsg('msg');
          if (!form.checkValidity()) { form.reportValidity(); return; }
          if (btnSubmit) { btnSubmit.disabled = true; btnSubmit.textContent = 'Mengirim...'; }

          try {
            const fd = new FormData(form);
            // combine tanggal_kejadian to detail if present
            const tanggal = form.querySelector('[name="tanggal_kejadian"]')?.value || '';
            const deskripsi = form.querySelector('[name="detail"]')?.value || '';
            if (tanggal) fd.set('detail', [tanggal, deskripsi].filter(Boolean).join('\n\n'));

            // ensure reporter_type
            fd.set('reporter_type', 'nasabah');

            // check files
            const attachmentKtp = fd.get('attachment_ktp');
            const attachmentBukti = fd.get('attachment_bukti');
            const hasFile = (attachmentKtp && attachmentKtp.size > 0) || (attachmentBukti && attachmentBukti.size > 0);

            const API_URL = normalizeApiUrl(getSavedApi());

            let res;
            if (hasFile) {
              res = await postFormData(API_URL, fd);
            } else {
              // convert FormData to plain object, removing empty strings
              const obj = {};
              for (const [k,v] of fd.entries()){
                if (v === '' || v === null) continue;
                obj[k] = v;
              }
              obj.reporter_type = 'nasabah';
              res = await postJson(API_URL, obj);
            }

            const data = await parseJsonSafe(res);
            if (!res.ok) {
              // try to extract useful message
              const msg = (data?.message) ? data.message :
                          (data?.errors) ? JSON.stringify(data.errors, null, 2) :
                          (data?._raw) ? data._raw :
                          `HTTP ${res.status} ${res.statusText}`;
              setMsg('msg','Gagal membuat tiket: ' + msg, 'err');
            } else {
              // success (201 or 200)
              const ticketNo = data?.data?.ticket_no || data?.ticket_no || data?.data?.id || '';
              setMsg('msg','Tiket berhasil dibuat: ' + (ticketNo || '(nomor tidak tersedia)'), 'ok');
              form.reset();
            }

          } catch (err) {
            setMsg('msg','Terjadi kesalahan: ' + (err.message || err), 'err');
            console.error(err);
          } finally {
            if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.textContent = 'Submit'; }
          }
        });

        // search handler
        btnSearch && btnSearch.addEventListener('click', function(e){
          e.preventDefault();
          const no = inputSearch.value || '';
          handleSearchTicket(no);
        });

        // allow Enter key in input to trigger search
        inputSearch && inputSearch.addEventListener('keydown', function(e){
          if (e.key === 'Enter') {
            e.preventDefault();
            btnSearch.click();
          }
        });
      }

    })();
  </script>
</body>
</html>
