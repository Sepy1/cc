<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buat Tiket — Nasabah</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#fff;
      --muted:#6b7280;
      --accent:#4f46e5;
      --radius:12px;
      --border:#e6e8eb;
      --input-bg:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; margin:0; min-height:100vh; background:linear-gradient(180deg,#fff,#fbfbfd); display:flex; align-items:flex-start; justify-content:center; padding:28px; color:#0b1220}

    .wrap{width:100%; max-width:1120px}
    .card{background:var(--card); border-radius:14px; padding:34px; box-shadow:0 12px 30px rgba(2,6,23,0.06); border:1px solid rgba(11,17,32,0.04); position:relative}

    h1{margin:0 0 6px; font-size:22px; font-weight:700}
    p.lead{margin:0 0 20px; color:var(--muted); font-size:14px}

    /* API settings */
    .api-settings { position:absolute; right:18px; top:18px; width:360px; background:#fafafa; border-radius:10px; padding:12px; border:1px solid var(--border); box-shadow:0 8px 20px rgba(2,6,23,0.03) }
    .api-settings h4{margin:0 0 8px; font-size:13px}
    .api-row{display:flex; gap:8px; align-items:center}
    .api-row input[type="text"]{flex:1; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); font-size:13px}
    .api-row button{padding:8px 10px; border-radius:8px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700}
    .api-actions{display:flex; gap:8px; margin-top:8px}
    .api-note{font-size:12px; color:var(--muted); margin-top:8px}

    form{display:block}

    /* layout grids */
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:28px; margin-bottom:18px}
    .grid-2{display:grid; grid-template-columns:repeat(2,1fr); gap:28px; margin-bottom:18px}
    .full{margin-bottom:18px}

    label.block{display:block}
    .label-title{font-weight:600; margin-bottom:6px; display:block; font-size:16px}
    .label-note{color:var(--muted); font-size:13px; margin-bottom:8px; display:block}

    input[type="text"], input[type="email"], input[type="tel"], input[type="date"], textarea, select, input[type="file"]{
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--border); background:var(--input-bg); font-size:14px; outline:none; color:#0b1220; box-shadow:none; height:44px;
    }
    textarea{min-height:120px; resize:vertical; padding-top:14px}
    input[disabled]{opacity:0.6}

    input::placeholder, textarea::placeholder{color:#6b7280}

    input:focus, textarea:focus, select:focus{border-color:var(--accent); box-shadow:0 8px 28px rgba(79,70,229,0.06)}

    .actions{display:flex; gap:12px; align-items:center; justify-content:flex-start; margin-top:6px}
    .btn{padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700}
    .btn.primary{background:var(--accent); color:white}
    .btn.ghost{background:transparent; border:1px solid var(--border); color:var(--muted)}

    .msg{margin-top:10px; font-size:14px}
    .ok{color:#0ea5a4}
    .err{color:#b91c1c; white-space:pre-wrap}

    .required{color:#b91c1c; margin-left:6px; font-weight:700}

    /* responsive */
    @media (max-width:1200px){
      .api-settings { position:static; width:100%; margin-bottom:16px; }
      .card{padding:22px}
    }
    @media (max-width:980px){
      .grid-3{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width:720px){
      .grid-3,.grid-2{grid-template-columns:1fr}
      .card{padding:18px}
    }

    /* visual alignment to match provided image */
    .label-title.small{font-size:14px; font-weight:600}
    .muted-note{color:var(--muted); font-size:13px}

    /* file inputs styling: keep native but visually balanced */
    .file-row{display:grid; grid-template-columns:1fr 1fr; gap:36px; margin-top:6px}

    /* submit area left aligned like the image */
    .submit-row{display:flex; gap:18px; align-items:center; margin-top:18px}

    .brand { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
    .brand img { height:36px; }
    .brand .appname { font-weight:700; font-size:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img src="/images/logo.png" alt="Logo">
        <div class="appname">Call Center</div>
      </div>
      <h1>Buat Tiket — Nasabah</h1>

      <form id="ticketForm" autocomplete="off" enctype="multipart/form-data" novalidate>
        <!-- reporter_type fixed (nasabah) -->
        <input type="hidden" name="reporter_type" value="nasabah">

        <!-- Judul / Layanan (full width as in image) -->
        <div class="full">
          <label class="block">
            <span class="label-title">Layanan (Judul tiket) <span class="required">*</span></span>
            <small class="label-note">Isi dengan layanan / judul masalah — disimpan ke <code>title</code></small>
            <input type="text" name="title" placeholder="Contoh: Transfer belum masuk" required>
          </label>
        </div>

        <!-- Nama dan Email (2 columns) -->
        <div class="grid-2">
          <label class="block">
            <span class="label-title">Nama Nasabah <span class="required">*</span></span>
                <input type="text" name="reporter_name" placeholder="Nama lengkap" required>
          </label>

          <label class="block">
            <span class="label-title">Email <span class="required">*</span></span>
            
            <input type="email" name="email" placeholder="email@contoh.com" required>
          </label>
        </div>

        <!-- No e-KTP, Alamat, Tempat Lahir (3 columns like image) -->
        <div class="grid-3">
          <label class="block">
            <span class="label-title">No e-KTP</span>
                       <input type="text" name="id_ktp" placeholder="Nomor KTP / e-KTP">
          </label>

          <label class="block">
            <span class="label-title">Nama Ibu</span>
            <input type="text" name="nama_ibu" placeholder="Nama ibu kandung">
          </label>

          <label class="block">
            <span class="label-title">Alamat <span class="required">*</span></span>
                       <input type="text" name="alamat" placeholder="Alamat domisili" required>
          </label>
        </div>

        <!-- Tanggal Lahir, No HP, No Rekening -->
        <div class="grid-3">
          <label class="block">
            <span class="label-title">Tanggal Lahir</span>
            
            <input type="date" name="tgl_lahir">
          </label>

          <label class="block">
            <span class="label-title">No. Telepon / HP <span class="required">*</span></span>
            
            <input type="tel" name="phone" placeholder="08xx xxxx xxxx" required>
          </label>

          <label class="block">
            <span class="label-title">No. Rekening <span class="required">*</span></span>
           
            <input type="text" name="nomor_rekening" placeholder="Nomor rekening" required>
          </label>
        </div>

        <!-- Pokok Pengaduan (dropdown), (placeholder), Tanggal Kejadian -->
        <div class="grid-3">
          <label class="block">
            <span class="label-title">Pokok Pengaduan (Kategori) <span class="required">*</span></span>
           
            <select name="category" required>
              <option value="" disabled selected>-- Pilih kategori --</option>
              <option value="tabungan">Tabungan</option>
              <option value="kredit">Kredit</option>
              <option value="deposito">Deposito</option>
              <option value="layanan_digital">Layanan Digital</option>
              <option value="lainnya">Lainnya</option>
            </select>
          </label>

          
          <label class="block">
            <span class="label-title">Tanggal Kejadian</span>
   
            <input type="date" name="tanggal_kejadian">
          </label>
        </div>

        <!-- Deskripsi -->
        <div class="full">
          <label class="block">
            <span class="label-title">Deskripsi Permasalahan <span class="required">*</span></span>
            <small class="label-note">Kronologis kejadian, tanggal & waktu, nominal transaksi, dll</small>
            <textarea name="detail" placeholder="Tuliskan kronologi singkat dan jelas..." required></textarea>
          </label>
        </div>

        <!-- Attach Files (side-by-side as image) -->
        <div class="file-row">
          <label class="block">
            <span class="label-title">Upload Foto / Scan KTP <span class="required">*</span></span>
            <small class="label-note">(jpg, png, pdf) — field <code>attachment_ktp</code></small>
            <input type="file" name="attachment_ktp" accept="image/*,.pdf" required>
          </label>

          <label class="block">
            <span class="label-title">Upload Bukti / Screenshot Transaksi</span>
            <small class="label-note">(opsional) — field <code>attachment_bukti</code></small>
            <input type="file" name="attachment_bukti" accept="image/*,.pdf">
          </label>
        </div>

        <!-- Hidden status default open -->
        <input type="hidden" name="status" value="open">

        <div class="submit-row">
          <button type="button" class="btn ghost" id="btnReset">Reset Form</button>
          <button type="submit" class="btn primary" id="btnSubmit">Submit</button>
        </div>

        <div id="msg" class="msg" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script>
    (function(){
      const LS_KEY = 'tiket_api_url';
      const LS_USE_REL = 'tiket_api_use_relative';
      const DEFAULT_API = 'http://127.0.0.1:8000/api/tickets';

      function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
      ready(main);

      function normalizeApiUrl(input){
        if (!input) return DEFAULT_API;
        let u = input.trim();
        // remove trailing slash
        if (u.endsWith('/')) u = u.slice(0, -1);
        // if contains /api then treat as full endpoint
        if (u.match(/\/api(\/|$)/)) return u;
        // otherwise assume base URL and append path
        return u + '/api/tickets';
      }

      function getSavedApi(){
        return localStorage.getItem(LS_KEY) || DEFAULT_API;
      }
      function getUseRelative(){
        return localStorage.getItem(LS_USE_REL) === '1';
      }

      function main(){
        const form = document.getElementById('ticketForm');
        const btnReset = document.getElementById('btnReset');
        const btnSubmit = document.getElementById('btnSubmit');
        const msg = document.getElementById('msg');

        if (!form) return console.warn('Form not found');

        btnReset && btnReset.addEventListener('click', () => { form.reset(); clearMsg(); });

        function setMsg(text, type='') { if (!msg) return; msg.textContent = text; msg.className = 'msg ' + (type === 'ok' ? 'ok' : type === 'err' ? 'err' : ''); }
        function clearMsg(){ if (msg) { msg.textContent=''; msg.className='msg'; } }

        form.addEventListener('submit', async function(e){
          e.preventDefault(); clearMsg();
          if (!form.checkValidity()) { form.reportValidity(); return; }
          if (btnSubmit) { btnSubmit.disabled = true; btnSubmit.textContent = 'Mengirim...'; }

          try {
            const fd = new FormData(form);
            // satukan tanggal_kejadian ke detail untuk memudahkan
            const tanggal = form.querySelector('[name="tanggal_kejadian"]')?.value || '';
            const deskripsi = form.querySelector('[name="detail"]')?.value || '';
            fd.set('detail', [tanggal, deskripsi].filter(Boolean).join('\n\n'));
            fd.set('reporter_type', 'nasabah'); // memastikan is_nasabah di API

            // Selalu kirim multipart jika ada file
            const hasFile =
              (fd.get('attachment_ktp') && fd.get('attachment_ktp').size > 0) ||
              (fd.get('attachment_bukti') && fd.get('attachment_bukti').size > 0);

            const API_URL = localStorage.getItem('tiket_api_url') || 'http://127.0.0.1:8000/api/tickets';
            let res;

            if (hasFile) {
              res = await fetch(API_URL, { method: 'POST', body: fd, mode: 'cors' });
            } else {
              // kirim JSON jika tanpa file
              const obj = Object.fromEntries(fd.entries());
              Object.keys(obj).forEach(k => { if (obj[k] === '') delete obj[k]; });
              obj.reporter_type = 'nasabah';
              res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(obj),
                mode: 'cors'
              });
            }

            const data = await res.json().catch(()=>({}));
            if (!res.ok) {
              setMsg((data?.message || 'Gagal membuat tiket') + (data?.errors ? '\n' + JSON.stringify(data.errors, null, 2) : ''), 'err');
            } else {
              setMsg('Tiket berhasil dibuat: ' + (data?.data?.ticket_no || '(nomor tidak tersedia)'), 'ok');
              form.reset();
            }
          } catch (err) {
            setMsg('Terjadi kesalahan: ' + (err.message || err), 'err');
          } finally {
            if (btnSubmit) { btnSubmit.disabled = false; btnSubmit.textContent = 'Submit'; }
          }
        });
      }
    })();
  </script>
</body>
</html>
