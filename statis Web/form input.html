<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Buat Tiket — Helpdesk (Tema Light)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #f6f8fb;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-start: #2563eb;
      --accent-end: #fcd38b;
      --success: #059669;
      --danger: #dc2626;
      --glass: rgba(15,23,42,0.03);
      --radius:12px;
      --text: #0b1220;
      --orange: #ffa500;
      --deep-blue: #0a00bd;
      --modal-overlay: rgba(2,6,23,0.6);
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--deep-blue); display:flex; align-items:center; justify-content:center; padding:40px;}
    .wrap{width:100%; max-width:920px; display:grid; grid-template-columns:1fr 520px; gap:24px}

    /* left image panel */
    .image-panel{border-radius:var(--radius); overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#ffffff,#f8fafc); box-shadow: 0 8px 24px rgba(16,24,40,0.04); border:1px solid rgba(15,23,42,0.04); padding:0}
    .image-panel img{width:100%; height:100%; object-fit:cover; display:block}

    .right-col { display:flex; flex-direction:column; gap:16px; }

    .card{background:var(--deep-blue); color:#ffffff; border-radius:var(--radius); padding:20px; border:1px solid rgba(255,255,255,0.12); box-shadow:0 12px 40px rgba(0,0,0,0.25)}
    .card.light { background: var(--card); color: var(--text); border:1px solid rgba(10,0,189,0.06); box-shadow: 0 8px 28px rgba(10,0,189,0.06); }
    .card .card-title { font-size:16px; font-weight:700; margin-bottom:10px; color:inherit; display:flex; align-items:center; gap:8px; }

    form{display:flex; flex-direction:column; gap:12px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:13px; color:inherit; margin-bottom:6px; display:block}
    .field{position:relative}
    input[type='text'], input[type='email'], textarea{width:100%; padding:12px 14px; border-radius:10px; background:#ffffff; border:1px solid rgba(0,0,0,0.12); color:#000000; outline:none; transition:box-shadow .12s, transform .09s}
    input:focus, textarea:focus{box-shadow:0 8px 24px rgba(37,99,235,0.08); transform:translateY(-1px)}
    textarea{min-height:120px; resize:vertical}

    .hint{font-size:12px; color:var(--muted); margin-top:6px}

    .btn{display:inline-flex; align-items:center; gap:10px; justify-content:center; padding:14px 20px; border-radius:10px; border:none; cursor:pointer; font-weight:800; background:var(--orange); color:#262c7a; box-shadow:0 10px 30px rgba(0,0,0,0.08)}
    .btn:active{transform:translateY(1px)}

    .small{font-size:13px; color:var(--muted)}

    .toast{position:fixed; right:20px; bottom:20px; min-width:260px; border-radius:12px; padding:14px 16px; box-shadow:0 12px 36px rgba(16,24,40,0.08); display:none}
    .toast.show{display:block; animation:toastIn .26s ease}
    .toast.success{background:linear-gradient(180deg, rgba(5,150,105,0.06), rgba(5,150,105,0.03)); border:1px solid rgba(5,150,105,0.08); color:var(--success)}
    .toast.error{background:linear-gradient(180deg, rgba(220,38,38,0.06), rgba(220,38,38,0.03)); border:1px solid rgba(220,38,38,0.08); color:var(--danger)}

    @keyframes toastIn{from{transform:translateY(10px); opacity:0}to{transform:none; opacity:1}}

    @media (max-width:880px){
      .wrap{grid-template-columns:1fr; padding:0}
      .image-panel{order:-1; height:200px}
    }

    .error-text{color:var(--danger); font-size:13px}
    input::placeholder, textarea::placeholder{color:#000000; opacity:1;}

    /* Tracking card specific */
    .tracker-controls{display:flex; gap:8px; align-items:center; margin-top:6px}
    .tracker-input{flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(10,0,189,0.08); background: #fff; color:#000}
    .search-btn{padding:10px 14px; border-radius:8px; border:none; cursor:pointer; background:var(--deep-blue); color:#fff; font-weight:600}
    .message{display:none; padding:10px 12px; border-radius:8px; margin-top:10px}
    .message.info{background:linear-gradient(180deg, rgba(37,99,235,0.06), rgba(37,99,235,0.03)); border:1px solid rgba(37,99,235,0.08); color:var(--deep-blue)}
    .message.error{background:linear-gradient(180deg, rgba(220,38,38,0.06), rgba(220,38,38,0.03)); border:1px solid rgba(220,38,38,0.08); color:var(--danger)}
    #result{display:none; margin-top:12px; padding:12px; border-radius:10px; background:linear-gradient(180deg,#fbfdff,#f1f6ff); border:1px solid rgba(10,0,189,0.06)}
    .result-row{display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-bottom:1px dashed rgba(10,0,189,0.04)}
    .result-row:last-child{border-bottom:none}
    .result-key{font-weight:600; color:var(--deep-blue)}
    .result-val{color:#1f2937; text-align:right}
    .muted-small{font-size:12px; color:var(--muted)}

    .fullwidth-section {
      width:100%;
      max-width:920px;
      margin:30px auto 0;
    }

    .fullwidth-section .card.light {
      width:100%;
    }

    /* --- Modal --- */
    .modal-overlay {
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:var(--modal-overlay); z-index:1200;
    }
    .modal-overlay.show { display:flex; }
    .modal {
      width:calc(100% - 40px); max-width:720px; border-radius:12px; background:var(--card); padding:18px; box-shadow:0 24px 80px rgba(2,6,23,0.6); color:var(--text);
      transform:translateY(6px); transition:transform .18s ease, opacity .18s ease;
    }
    .modal.show { transform:none; opacity:1; }
    .modal-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .modal-title { font-size:18px; font-weight:700; color:var(--deep-blue); }
    .modal-close { background:transparent; border:none; font-size:18px; cursor:pointer; color:var(--muted) }
    .modal-body { margin-top:10px; max-height:60vh; overflow:auto; }

    .modal-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px; }
    .modal-row { background:linear-gradient(180deg,#fbfdff,#fff); padding:10px; border-radius:8px; border:1px solid rgba(10,0,189,0.04) }
    .modal-key { font-weight:700; color:var(--deep-blue); margin-bottom:6px; }
    .modal-val { color:#1f2937; font-size:14px; }

    /* badge styles for statuses */
    .badge { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px; color:#fff; }
    .badge.green{ background: linear-gradient(180deg,#10b981,#059669); }
    .badge.yellow{ background: linear-gradient(180deg,#fbbf24,#f59e0b); color:#111827; }
    .badge.red{ background: linear-gradient(180deg,#f43f5e,#dc2626); }
    .badge.blue{ background: linear-gradient(180deg,#60a5fa,#2563eb); }
    .badge.gray{ background: linear-gradient(180deg,#e5e7eb,#d1d5db); color:#111827; }

    /* small helper for long detail text */
    .detail-text { white-space:pre-wrap; color:#1f2937; font-size:14px; }
  </style>
</head>
<body>
  <div class="page">

    <!-- WRAP: gambar + form tiket -->
    <div class="wrap">

      <!-- LEFT: illustration image -->
      <div class="image-panel" aria-hidden="true">
        <img src="lapor.png" alt="Ilustrasi helpdesk">
      </div>

      <!-- RIGHT: form card -->
      <div class="card" aria-live="polite">
        <div class="card-title">Buat Tiket Baru</div>

        <form id="ticketForm" novalidate>

          <div class="row">
            <div class="field">
              <label for="reporter_name">Nama Pelapor *</label>
              <input id="reporter_name" name="reporter_name" type="text" required>
              <div class="error-text" id="err_reporter_name"></div>
            </div>

            <div class="field">
              <label for="phone">No HP</label>
              <input id="phone" name="phone" type="text" placeholder="0812xxxx">
            </div>
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email">
            <div class="error-text" id="err_email"></div>
          </div>

          <div class="field">
            <label for="title">Judul Aduan *</label>
            <input id="title" name="title" type="text" required>
            <div class="error-text" id="err_title"></div>
          </div>

          <div class="field">
            <label for="detail">Detail Permasalahan *</label>
            <textarea id="detail" name="detail" required></textarea>
            <div class="error-text" id="err_detail"></div>
          </div>

          <div style="display:flex; justify-content:flex-end; margin-top:6px">
            <button type="submit" class="btn" id="submitBtn">Kirim Tiket</button>
          </div>

        </form>
      </div>

    </div> <!-- END WRAP -->

    <!-- FULL WIDTH SECTION UNTUK TRACKING -->
    <div class="fullwidth-section">
      <div class="card light" id="trackerCard" aria-live="polite">
        <div class="card-title">Lacak Tiket</div>

        <label for="ticketNo">Nomor Tiket</label>
        <div class="tracker-controls">
          <input id="ticketNo" class="tracker-input" type="text" placeholder="Masukkan nomor tiket...">
          <button id="btnSearch" class="search-btn" type="button">Cari</button>
        </div>

        <div id="message" class="message" style="display:none"></div>

        <!-- kept for backward compatibility, but results will show in modal -->
        <div id="result" style="display:none"></div>

      </div>
    </div>

  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal -->
  <div id="modalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">Hasil Pencarian Tiket</div>
        <button id="modalClose" class="modal-close" aria-label="Tutup">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- content will be injected -->
        <div style="display:flex; align-items:center; justify-content:space-between; gap:12px">
          <div>
            <div style="font-size:14px; color:var(--muted)">Nomor Tiket</div>
            <div id="m_ticket_no" style="font-weight:800; font-size:16px; color:var(--deep-blue)">—</div>
          </div>
          <div id="m_status_wrap" style="text-align:right">
            <!-- badge inserted here -->
            <span id="m_status_badge" class="badge gray">—</span>
          </div>
        </div>

        <div class="modal-grid" style="margin-top:12px">
          <div class="modal-row">
            <div class="modal-key">Judul</div>
            <div class="modal-val" id="m_title">—</div>
          </div>
          <div class="modal-row">
            <div class="modal-key">Pelapor</div>
            <div class="modal-val" id="m_reporter">—</div>
          </div>

          <div class="modal-row">
            <div class="modal-key">Kontak</div>
            <div class="modal-val" id="m_contact">—</div>
          </div>
          <div class="modal-row">
            <div class="modal-key">Kategori</div>
            <div class="modal-val" id="m_category">—</div>
          </div>

          <div style="grid-column:1 / -1" class="modal-row">
            <div class="modal-key">Detail</div>
            <div class="modal-val detail-text" id="m_detail">—</div>
          </div>

          <div class="modal-row">
            <div class="modal-key">Dibuat</div>
            <div class="modal-val" id="m_created_at">—</div>
          </div>
          <div class="modal-row">
            <div class="modal-key">Update Terakhir</div>
            <div class="modal-val" id="m_updated_at">—</div>
          </div>
        </div>

        <div style="margin-top:12px; text-align:right">
          <button id="modalCloseBottom" class="search-btn" type="button">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPT: form submit + tracker (diletakkan di akhir agar elemen sudah ada) -->
  <script>
    /* ---------- HELPERS: parse ISO safely (trim microseconds) + format to Asia/Jakarta ---------- */
    function parseIsoToDate(iso) {
      if (!iso) return null;
      if (iso instanceof Date) return isNaN(iso) ? null : iso;
      try {
        let s = String(iso).trim();
        s = s.replace(/(\.\d{3})\d+Z$/, '$1Z').replace(/(\.\d{3})\d+([+-]\d{2}:\d{2})$/, '$1$2');
        if (!/[zZ]|[+\-]\d{2}:\d{2}$/.test(s)) s = s + 'Z';
        const dt = new Date(s);
        return isNaN(dt) ? null : dt;
      } catch (e) {
        return null;
      }
    }

    function formatDateIso(iso, opts = {}) {
      const dt = parseIsoToDate(iso);
      if (!dt) return '—';
      try {
        const defaultOptions = {
          year: 'numeric', month: 'long', day: 'numeric',
          hour: '2-digit', minute: '2-digit', second: '2-digit',
          hour12: false
        };
        const formatOptions = Object.assign({}, defaultOptions, opts);
        const formatter = new Intl.DateTimeFormat('id-ID', Object.assign({ timeZone: 'Asia/Jakarta' }, formatOptions));
        const formatted = formatter.format(dt);
        return formatted + ' WIB';
      } catch (e) {
        try {
          const localMs = dt.getTime() + (7 * 60 * 60 * 1000);
          const local = new Date(localMs);
          const pad = n => String(n).padStart(2,'0');
          const day = pad(local.getUTCDate());
          const monthNames = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
          const month = monthNames[local.getUTCMonth()];
          const year = local.getUTCFullYear();
          const hh = pad(local.getUTCHours());
          const mm = pad(local.getUTCMinutes());
          const ss = pad(local.getUTCSeconds());
          return `${day} ${month} ${year}, ${hh}:${mm}:${ss} WIB`;
        } catch (ee) {
          return '—';
        }
      }
    }

    /* ---------- FORM SUBMIT SCRIPT ---------- */
    (function(){
      const form = document.getElementById('ticketForm');
      const toast = document.getElementById('toast');
      const submitBtn = document.getElementById('submitBtn');

      function showToast(message, type='success'){
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(()=> toast.className = 'toast', 4500);
      }

      function clearErrors(){
        ['reporter_name','email','title','detail'].forEach(k=>{
          const el = document.getElementById('err_'+k);
          if(el) el.textContent = '';
        });
      }

      function validateForm(data){
        const errors = {};
        if(!data.reporter_name || data.reporter_name.trim().length < 2) errors.reporter_name = 'Nama pelapor minimal 2 karakter.';
        if(data.email && !/^[\w.+-]+@[\w-]+\.[\w.-]+$/.test(data.email)) errors.email = 'Format email tidak valid.';
        if(!data.title || data.title.trim().length < 3) errors.title = 'Judul minimal 3 karakter.';
        if(!data.detail || data.detail.trim().length < 10) errors.detail = 'Detail permasalahan terlalu singkat.';
        return errors;
      }

      if(form){
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          submitBtn.disabled = true;

          clearErrors();
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());

          const errors = validateForm(data);
          if(Object.keys(errors).length){
            Object.entries(errors).forEach(([k,msg])=>{
              const el = document.getElementById('err_'+k);
              if(el) el.textContent = msg;
            });
            showToast('Perbaiki isian yang berwarna merah.', 'error');
            submitBtn.disabled = false;
            return;
          }

          try{
            submitBtn.innerHTML = 'Mengirim...';
            const res = await fetch('http://127.0.0.1:8000/api/tickets', {
              method:'POST',
              headers:{'Content-Type':'application/json','Accept':'application/json'},
              body: JSON.stringify(data)
            });

            let result;
            try { result = await res.json(); } catch(e){ result = { message: 'Response tidak valid' }; }

            if(res.ok){
              showToast('Tiket berhasil dibuat — Nomor: '+(result.data?.ticket_no || result.ticket_no || '—'));
              form.reset();
            } else {
              if(result.errors){
                Object.entries(result.errors).forEach(([k,v])=>{
                  const el = document.getElementById('err_'+k);
                  if(el) el.textContent = Array.isArray(v)? v.join(' ') : v;
                });
                showToast('Validasi gagal. Periksa kembali.', 'error');
              } else {
                showToast(result.message || 'Terjadi kesalahan pada server.', 'error');
              }
            }
          }catch(err){
            console.error(err);
            showToast('Gagal menghubungi server API.', 'error');
          } finally{
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Kirim Tiket';
          }
        });
      }
    })();

    /* ---------- TRACKING + MODAL SCRIPT (IIFE) ---------- */
    (function(){
      const baseApi = "http://127.0.0.1:8000/api"; // ganti sesuai domain API Anda
      const btn = document.getElementById('btnSearch');
      const ticketInput = document.getElementById('ticketNo');
      const message = document.getElementById('message');
      const resultBox = document.getElementById('result');

      const modalOverlay = document.getElementById('modalOverlay');
      const modalClose = document.getElementById('modalClose');
      const modalCloseBottom = document.getElementById('modalCloseBottom');

      function showMessage(text, type='info') {
        if(!message) return;
        message.style.display = 'block';
        message.className = 'message ' + (type==='error' ? 'error' : 'info');
        message.innerHTML = text;
      }

      function hideMessage() { if(message) message.style.display = 'none'; }
      function hideResult() { if(resultBox) resultBox.style.display = 'none'; }

      function statusToBadge(statusRaw) {
        const s = (statusRaw || '').toString().toLowerCase();
        if (!s) return { text: '—', cls: 'badge gray' };
        if (s.includes('open') || s.includes('baru') || s.includes('new')) return { text: capitalize(s), cls: 'badge red' };
        if (s.includes('pending') || s.includes('hold') || s.includes('sedang di proses')) return { text: capitalize(s), cls: 'badge yellow' };
        if (s.includes('closed') || s.includes('closed') || s.includes('selesai') || s.includes('done')) return { text: capitalize(s), cls: 'badge green' };
        if (s.includes('resolved') || s.includes('selesai') || s.includes('resolved')) return { text: capitalize(s), cls: 'badge green' };
        if (s.includes('rejected') || s.includes('tolak') || s.includes('rejected')) return { text: capitalize(s), cls: 'badge red' };
        if (s.includes('in_progress') || s.includes('progress') || s.includes('proses') || s.includes('doing')) return { text: capitalize(s), cls: 'badge blue' };
        // default
        return { text: capitalize(s), cls: 'badge blue' };
      }

      function capitalize(s) {
        if(!s) return s;
        return s.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
      }

      function renderTicketToModal(obj) {
        if(!obj || typeof obj !== 'object') {
          showMessage('Data tiket tidak valid.', 'error');
          return;
        }
        // fill modal fields
        document.getElementById('m_ticket_no').textContent = obj.ticket_no ?? obj.ticketNo ?? obj.id ?? '—';
        const statusRaw = obj.status ?? obj.state ?? '';
        const badge = statusToBadge(statusRaw);
        const badgeEl = document.getElementById('m_status_badge');
        badgeEl.className = badge.cls;
        badgeEl.textContent = badge.text;

        document.getElementById('m_title').textContent = obj.title ?? obj.subject ?? '—';
        document.getElementById('m_reporter').textContent = obj.reporter_name ?? obj.reporter ?? '—';
        const contact = ((obj.phone ? 'HP: ' + obj.phone : '') + (obj.email ? (', Email: ' + obj.email) : '') ) || '—';
        document.getElementById('m_contact').textContent = contact;
        document.getElementById('m_category').textContent = obj.category ?? obj.kategori ?? '—';
        document.getElementById('m_detail').textContent = obj.detail ?? obj.description ?? '—';
        document.getElementById('m_created_at').textContent = formatDateIso(obj.created_at ?? obj.createdAt ?? obj.created_at_readable ?? null);
        document.getElementById('m_updated_at').textContent = formatDateIso(obj.updated_at ?? obj.updatedAt ?? obj.updated_at_readable ?? null);
      }

      function openModal() {
        if(!modalOverlay) return;
        modalOverlay.classList.add('show');
        modalOverlay.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
      }

      function closeModal() {
        if(!modalOverlay) return;
        modalOverlay.classList.remove('show');
        modalOverlay.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }

      async function fetchByPath(path) {
        try {
          const res = await fetch(path, { method: 'GET', headers: { 'Accept': 'application/json' } });
          const text = await res.text();
          let data = null;
          try { data = text ? JSON.parse(text) : null; } catch(e) { data = text; }
          return { ok: res.ok, status: res.status, data };
        } catch (err) {
          return { ok: false, status: 0, data: null, error: err.message };
        }
      }

      // guard
      if (!btn) {
        console.warn('Tracker: tombol btnSearch tidak ditemukan di halaman.');
        return;
      }

      btn.addEventListener('click', async function(){
        hideMessage(); hideResult();

        const ticketNo = ticketInput.value.trim();
        if (!ticketNo) {
          showMessage("Masukkan nomor tiket terlebih dahulu.", "error");
          return;
        }

        showMessage("Mencari tiket...", "info");

        // 1) coba RESTful: GET /api/tickets/{ticket_no}
        let try1 = await fetchByPath(`${baseApi}/tickets/${encodeURIComponent(ticketNo)}`);
        if (try1.ok) {
          let payload = try1.data;
          if (payload && payload.data) payload = payload.data;
          hideMessage();
          renderTicketToModal(payload);
          openModal();
          return;
        }

        // 2) jika 404 atau tidak ok, coba query param: GET /api/tickets?ticket_no=...
        let try2 = await fetchByPath(`${baseApi}/tickets?ticket_no=${encodeURIComponent(ticketNo)}`);
        if (try2.ok) {
          let payload = try2.data;
          if (payload && payload.data) {
            const d = Array.isArray(payload.data) ? payload.data[0] : payload.data;
            if (!d) { showMessage("Tiket tidak ditemukan.", "error"); return; }
            renderTicketToModal(d);
            hideMessage();
            openModal();
            return;
          }
          if (Array.isArray(payload)) {
            if (payload.length === 0) { showMessage("Tiket tidak ditemukan.", "error"); return; }
            renderTicketToModal(payload[0]);
            hideMessage();
            openModal();
            return;
          }
          if (payload && (payload.ticket_no || payload.id)) {
            renderTicketToModal(payload);
            hideMessage();
            openModal();
            return;
          }
          showMessage("Tiket tidak ditemukan.", "error");
          return;
        }

        if (try1.status === 0 && try2.status === 0) {
          showMessage("Gagal menghubungi server API. Pastikan server API aktif & CORS mengizinkan origin ini.", "error");
        } else {
          showMessage("Tiket tidak ditemukan atau terjadi kesalahan. (HTTP: " + (try1.status || try2.status) + ")", "error");
        }
      });

      // enable Enter to search
      if (ticketInput) {
        ticketInput.addEventListener('keydown', function(e){
          if(e.key === 'Enter') {
            e.preventDefault();
            btn.click();
          }
        });
      }

      // modal close handlers
      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (modalCloseBottom) modalCloseBottom.addEventListener('click', closeModal);
      if (modalOverlay) {
        modalOverlay.addEventListener('click', function(e){
          if (e.target === modalOverlay) closeModal();
        });
      }
      // close on Escape
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeModal();
      });

    })();
  </script>

</body>
</html>
